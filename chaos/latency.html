<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
      <title>Latency chaos strategy | Polly </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Latency chaos strategy | Polly ">
      
      
      <link rel="icon" href="../icon.png">
      <link rel="stylesheet" href="../public/docfx.min.css">
      <link rel="stylesheet" href="../public/main.css">
      <meta name="docfx:navrel" content="../toc.html">
      <meta name="docfx:tocrel" content="../toc.html">
      
      <meta name="docfx:rel" content="../">
      
      
      <meta name="docfx:docurl" content="https://github.com/App-vNext/Polly/blob/main/docs/chaos/latency.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">
  </head>

  <script type="module" src="./../public/docfx.min.js"></script>

  <script>
    const theme = localStorage.getItem('theme') || 'auto'
    document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
  </script>


  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../index.html">
            <img id="logo" class="svg" src="../icon.png" alt="Polly">
            Polly
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled="" placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" style="margin-top: -.65em; margin-left: -.8em" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="latency-chaos-strategy">Latency chaos strategy</h1>

<div class="IMPORTANT">
<h5>Important</h5>
<p>This documentation page describes an upcoming feature of Polly.</p>
</div>
<h2 id="about">About</h2>
<ul>
<li><strong>Options</strong>: <a class="xref" href="../api/Polly.Simmy.Latency.LatencyStrategyOptions.html"><code>LatencyStrategyOptions</code></a></li>
<li><strong>Extensions</strong>: <code>AddChaosLatency</code></li>
<li><strong>Strategy Type</strong>: Proactive</li>
</ul>
<hr>
<p>The latency chaos strategy is designed to introduce controlled delays into system operations, simulating network latency or slow processing times. This strategy helps in assessing and improving the resilience of applications against increased response times.</p>
<h2 id="usage">Usage</h2>
<!-- snippet: chaos-latency-usage -->
<pre><code class="lang-cs">// Latency using the default options.
// See https://www.pollydocs.org/chaos/latency#defaults for defaults.
var optionsDefault = new LatencyStrategyOptions();

// 10% of invocations will be randomly affected.
var basicOptions = new LatencyStrategyOptions
{
    Latency = TimeSpan.FromSeconds(30),
    Enabled = true,
    InjectionRate = 0.1
};

// To use a custom function to generate the latency to inject.
var optionsWithLatencyGenerator = new LatencyStrategyOptions
{
    LatencyGenerator = static args =&gt;
    {
        TimeSpan latency = args.Context.OperationKey switch
        {
            &quot;DataLayer&quot; =&gt; TimeSpan.FromMilliseconds(500),
            &quot;ApplicationLayer&quot; =&gt; TimeSpan.FromSeconds(2),
            _ =&gt; TimeSpan.Zero // When the latency generator returns Zero the strategy won't inject any delay and it will just invoke the user's callback
        };

        return new ValueTask&lt;TimeSpan&gt;(latency);
    },
    Enabled = true,
    InjectionRate = 0.1
};

// To get notifications when a delay is injected
var optionsOnBehaviorInjected = new LatencyStrategyOptions
{
    Latency = TimeSpan.FromSeconds(30),
    Enabled = true,
    InjectionRate = 0.1,
    OnLatency = static args =&gt;
    {
        Console.WriteLine($&quot;OnLatency, Latency: {args.Latency}, Operation: {args.Context.OperationKey}.&quot;);
        return default;
    }
};

// Add a latency strategy with a LatencyStrategyOptions instance to the pipeline
new ResiliencePipelineBuilder().AddChaosLatency(optionsDefault);
new ResiliencePipelineBuilder&lt;HttpStatusCode&gt;().AddChaosLatency(optionsWithLatencyGenerator);

// There are also a handy overload to inject the chaos easily.
new ResiliencePipelineBuilder().AddChaosLatency(0.1, TimeSpan.FromSeconds(30));
</code></pre>
<!-- endSnippet -->
<p>Example execution:</p>
<!-- snippet: chaos-latency-execution -->
<pre><code class="lang-cs">var pipeline = new ResiliencePipelineBuilder()
    .AddRetry(new RetryStrategyOptions
    {
        ShouldHandle = new PredicateBuilder().Handle&lt;TimeoutRejectedException&gt;(),
        BackoffType = DelayBackoffType.Exponential,
        UseJitter = true,  // Adds a random factor to the delay
        MaxRetryAttempts = 4,
        Delay = TimeSpan.FromSeconds(3),
    })
    .AddTimeout(TimeSpan.FromSeconds(5))
    .AddChaosLatency(new LatencyStrategyOptions // Chaos strategies are usually placed as the last ones in the pipeline
    {
        Latency = TimeSpan.FromSeconds(10),
        Enabled = true,
        InjectionRate = 0.1
    })
    .Build();
</code></pre>
<!-- endSnippet -->
<h2 id="defaults">Defaults</h2>
<table>
<thead>
<tr>
<th>Property</th>
<th>Default Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Latency</code></td>
<td><code>30 seconds</code></td>
<td>A <code>TimeSpan</code> indicating the delay to be injected.</td>
</tr>
<tr>
<td><code>LatencyGenerator</code></td>
<td><code>null</code></td>
<td>Generates the latency to inject for a given execution.</td>
</tr>
<tr>
<td><code>OnLatency</code></td>
<td><code>null</code></td>
<td>Action executed when latency is injected.</td>
</tr>
</tbody>
</table>
<h2 id="diagrams">Diagrams</h2>
<h3 id="normal--sequence-diagram">Normal 🐵 sequence diagram</h3>
<pre><code class="lang-mermaid">sequenceDiagram
    actor C as Caller
    participant P as Pipeline
    participant L as Latency
    participant D as DecoratedUserCallback

    C-&gt;&gt;P: Calls ExecuteAsync
    P-&gt;&gt;L: Calls ExecuteCore
    activate L
    L-&gt;&gt;L: Determines Injection&lt;br/&gt;Decision: 🐵
    deactivate L
    L-&gt;&gt;+D: Invokes
    D-&gt;&gt;-L: Returns result
    L-&gt;&gt;P: Returns result
    P-&gt;&gt;C: Returns result
</code></pre>
<h3 id="chaos--sequence-diagram">Chaos 🙈 sequence diagram</h3>
<pre><code class="lang-mermaid">sequenceDiagram
    actor C as Caller
    participant P as Pipeline
    participant L as Latency
    participant D as DecoratedUserCallback

    C-&gt;&gt;P: Calls ExecuteAsync
    P-&gt;&gt;L: Calls ExecuteCore
    activate L
    L-&gt;&gt;L: Determines Injection&lt;br/&gt;Decision: 🙈
    L--&gt;&gt;L: Injects Latency
    deactivate L
    L-&gt;&gt;+D: Invokes
    D-&gt;&gt;-L: Returns result
    L-&gt;&gt;P: Returns result
    P-&gt;&gt;C: Returns result
</code></pre>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/App-vNext/Polly/blob/main/docs/chaos/latency.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          <span>Made with <a href="https://dotnet.github.io/docfx">docfx</a></span>
        </div>
      </div>
    </footer>
  </body>
</html>
